<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üö® EMERGENCY PORTAL DIAGNOSTIC</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { background: white; padding: 20px; border-radius: 8px; max-width: 800px; }
        .success { color: #22c55e; font-weight: bold; }
        .error { color: #ef4444; font-weight: bold; }
        .warning { color: #f59e0b; font-weight: bold; }
        .test { margin: 15px 0; padding: 10px; border-left: 4px solid #3b82f6; background: #eff6ff; }
        code { background: #f3f4f6; padding: 2px 6px; border-radius: 4px; font-family: monospace; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üö® EMERGENCY PORTAL DIAGNOSTIC</h1>
        <p><strong>Purpose:</strong> Identify why the supabase error persists</p>
        
        <div class="test">
            <h3>üìç Current Environment</h3>
            <div id="env-info"></div>
        </div>
        
        <div class="test">
            <h3>üîç Supabase Library Test</h3>
            <div id="library-test"></div>
        </div>
        
        <div class="test">
            <h3>‚ö° Initialization Test</h3>
            <div id="init-test"></div>
        </div>
        
        <div class="test">
            <h3>üåê File Access Test</h3>
            <div id="file-test"></div>
        </div>
        
        <div class="test">
            <h3>üìã Instructions for Ahmad</h3>
            <div id="user-instructions"></div>
        </div>
    </div>

    <script>
        console.log('üö® EMERGENCY DIAGNOSTIC STARTED');
        
        // Environment info
        document.getElementById('env-info').innerHTML = `
            <strong>URL:</strong> <code>${window.location.href}</code><br>
            <strong>Timestamp:</strong> <code>${new Date().toISOString()}</code><br>
            <strong>Browser:</strong> <code>${navigator.userAgent.split(' ')[0]}</code><br>
            <strong>Platform:</strong> <code>${navigator.platform}</code>
        `;
        
        // Library test
        function testLibrary() {
            const div = document.getElementById('library-test');
            
            if (typeof window.supabase === 'undefined') {
                div.innerHTML = '<span class="error">‚ùå CRITICAL: Supabase library not loaded!</span><br>This explains the error.';
                return false;
            }
            
            if (typeof window.supabase.createClient !== 'function') {
                div.innerHTML = '<span class="error">‚ùå CRITICAL: createClient method missing!</span>';
                return false;
            }
            
            div.innerHTML = '<span class="success">‚úÖ Supabase library loaded correctly</span>';
            return true;
        }
        
        // Initialization test  
        function testInitialization() {
            const div = document.getElementById('init-test');
            
            try {
                const SUPABASE_URL = 'https://mvftaaxgdygeyzcvzqfr.supabase.co';
                const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im12ZnRhYXhnZHlnZXl6Y3Z6cWZyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg2MjI3OTQsImV4cCI6MjA3NDE5ODc5NH0.nj5c_AAEg4U2qlcE1vQDMWt0nfXpmUYR1lrTR6KCIDY';
                
                // Test multiple initialization attempts
                const client1 = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                const client2 = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                
                div.innerHTML = `
                    <span class="success">‚úÖ First client created successfully</span><br>
                    <span class="success">‚úÖ Second client created successfully</span><br>
                    <span class="success">‚úÖ Multiple initialization works fine</span><br>
                    <strong>Client validation:</strong><br>
                    - Has from method: <code>${typeof client1.from === 'function'}</code><br>
                    - Has auth object: <code>${typeof client1.auth === 'object'}</code><br>
                    - Client type: <code>${typeof client1}</code>
                `;
                
                console.log('‚úÖ DIAGNOSTIC: Multiple supabase clients created without error');
                return true;
                
            } catch (error) {
                div.innerHTML = `<span class="error">‚ùå INITIALIZATION FAILED: ${error.message}</span>`;
                console.error('‚ùå DIAGNOSTIC: Supabase initialization failed:', error);
                return false;
            }
        }
        
        // File access test
        async function testFileAccess() {
            const div = document.getElementById('file-test');
            
            try {
                const portalUrl = window.location.href.replace('EMERGENCY_DIAGNOSTIC.html', 'CSIATTRIBUTESCREATIONV52.html');
                
                div.innerHTML = `<span class="warning">‚è≥ Testing file access...</span><br>Portal URL: <code>${portalUrl}</code>`;
                
                const response = await fetch(portalUrl);
                const content = await response.text();
                
                const hasUltimateFix = content.includes('initializeSupabaseUltimate');
                const hasEnhancedFix = content.includes('window.globalSupabase');
                const hasBrokenCode = content.includes('const supabase = window.supabase.createClient');
                const hasBasicFix = content.includes('let supabase;');
                
                let result = `<strong>File Analysis Results:</strong><br>`;
                result += `- File size: <code>${content.length} bytes</code><br>`;
                result += `- Response status: <code>${response.status}</code><br>`;
                
                if (hasUltimateFix) {
                    result += `<span class="success">‚úÖ ULTIMATE FIX DETECTED</span><br>`;
                } else if (hasEnhancedFix) {
                    result += `<span class="success">‚úÖ ENHANCED FIX DETECTED</span><br>`;
                } else if (hasBasicFix && !hasBrokenCode) {
                    result += `<span class="warning">‚ö†Ô∏è BASIC FIX DETECTED</span><br>`;
                } else if (hasBrokenCode) {
                    result += `<span class="error">‚ùå BROKEN CODE STILL PRESENT!</span><br>`;
                } else {
                    result += `<span class="error">‚ùå UNKNOWN FILE VERSION</span><br>`;
                }
                
                div.innerHTML = result;
                
            } catch (error) {
                div.innerHTML = `<span class="error">‚ùå FILE ACCESS FAILED: ${error.message}</span>`;
            }
        }
        
        // User instructions
        function showInstructions() {
            const div = document.getElementById('user-instructions');
            div.innerHTML = `
                <h4>üìß Ahmad - Send This Info to Admin:</h4>
                <ol>
                    <li><strong>Take screenshot</strong> of this entire page</li>
                    <li><strong>Copy this URL:</strong> <code>${window.location.href}</code></li>
                    <li><strong>Try the portal:</strong> <a href="CSIATTRIBUTESCREATIONV52.html" target="_blank">Portal Link</a></li>
                    <li><strong>If portal fails:</strong> Take screenshot of console errors</li>
                    <li><strong>Send all screenshots</strong> to admin immediately</li>
                </ol>
                
                <h4>üîß Expected Results:</h4>
                <ul>
                    <li>‚úÖ All tests above should show green checkmarks</li>
                    <li>‚úÖ Portal should load without JavaScript errors</li>
                    <li>‚úÖ Console should show: "Supabase ULTIMATE initialization successful"</li>
                </ul>
            `;
        }
        
        // Run all tests
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                testLibrary();
                testInitialization(); 
                testFileAccess();
                showInstructions();
            }, 1000);
        });
        
        console.log('üîç DIAGNOSTIC: All tests will run in 1 second');
    </script>
</body>
</html>
